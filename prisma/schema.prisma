generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------- ENUMS --------------------

enum Role {
  customer
  service_provider
  local_service_manager
  admin
}

enum ProviderStatus {
  pending // ðŸ”¹ Added for onboarding stage
  active
  inactive
  banned
}

enum LSMStatus {
  active
  inactive
}

enum JobStatus {
  new // ðŸ”¹ Added for when form is first submitted
  in_progress
  completed
  cancelled
  paid // ðŸ”¹ Added per your requirement flow
  rejected
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum SenderType {
  customer
  service_provider
  local_service_manager
  admin
}

enum NotificationType {
  job
  payment
  message
  system
  feedback
}

enum NotificationChannel {
  in_app
  email
}

enum MessageType {
  text
  image
  document
}

// -------------------- USERS --------------------

model users {
  id                Int       @id @default(autoincrement())
  first_name        String
  last_name         String
  email             String    @unique
  phone_number      String
  role              Role
  password          String
  refresh_token     String?
  is_email_verified Boolean   @default(false)
  last_login        DateTime?
  profile_picture   String? // ðŸ”¹ store path instead of bytes for ease
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  customer              customers?
  service_provider      service_providers?
  local_service_manager local_service_managers?
  admin                 admin?
}

// -------------------- CUSTOMER --------------------

model customers {
  id         Int                @id @default(autoincrement())
  user_id    Int                @unique
  user       users              @relation(fields: [user_id], references: [id])
  address    String
  zipcode    String? // ðŸ”¹ added to filter services by area
  jobs       jobs[]
  chats      chat[]
  feedbacks  ratings_feedback[]
  created_at DateTime           @default(now())
}

// -------------------- SERVICE PROVIDER --------------------

model service_providers {
  id                    Int                    @id @default(autoincrement())
  user_id               Int                    @unique
  user                  users                  @relation(fields: [user_id], references: [id])
  experience            Int
  description           String?
  location              String
  zipcode               String?
  rating                Decimal                @default(0.0) @db.Decimal(3, 2)
  tier                  String                 @default("Bronze")
  status                ProviderStatus         @default(pending)
  is_active             Boolean                @default(true)
  lsm_id                Int
  local_service_manager local_service_managers @relation(fields: [lsm_id], references: [id])
  total_jobs            Int                    @default(0)
  earning               Decimal                @default(0.0) @db.Decimal(10, 2)
  created_at            DateTime               @default(now())
  updated_at            DateTime               @updatedAt

  jobs      jobs[]
  chats     chat[]
  services  services[]         @relation("created_services")
  feedbacks ratings_feedback[]
}

// -------------------- LOCAL SERVICE MANAGER --------------------

model local_service_managers {
  id                 Int                 @id @default(autoincrement())
  user_id            Int                 @unique
  user               users               @relation(fields: [user_id], references: [id])
  region             String
  status             LSMStatus           @default(active)
  closed_deals_count Int?                @default(0)
  earnings           Decimal?            @default(0.00) @db.Decimal(10, 2)
  service_providers  service_providers[]
  services           services[]          @relation("approved_services")
  chats              chat[]
  created_at         DateTime            @default(now())
  updated_at         DateTime            @updatedAt
}

// -------------------- ADMIN --------------------

model admin {
  id         Int      @id @default(autoincrement())
  user_id    Int      @unique
  user       users    @relation(fields: [user_id], references: [id])
  created_at DateTime @default(now())
}

// -------------------- SERVICES --------------------

model services {
  id                    Int                     @id @default(autoincrement())
  name                  String
  description           String?
  category              String // ðŸ”¹ Added for search/filter
  created_by            Int
  service_provider      service_providers       @relation("created_services", fields: [created_by], references: [id])
  approved_by           Int?
  local_service_manager local_service_managers? @relation("approved_services", fields: [approved_by], references: [id])
  status                ApprovalStatus          @default(pending)
  is_popular            Boolean                 @default(false) // ðŸ”¹ For homepage
  questions_json        Json? // ðŸ”¹ dynamic service questions
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt

  jobs jobs[]
}

// -------------------- JOBS --------------------

model jobs {
  id               Int               @id @default(autoincrement())
  customer_id      Int
  customer         customers         @relation(fields: [customer_id], references: [id])
  provider_id      Int
  service_provider service_providers @relation(fields: [provider_id], references: [id])
  service_id       Int
  service          services          @relation(fields: [service_id], references: [id])
  status           JobStatus         @default(new)
  description      String?
  price            Decimal           @default(0.00) @db.Decimal(10, 2)
  location         String
  answers_json         Json? // ðŸ”¹ dynamic form answers
  scheduled_at     DateTime?
  completed_at     DateTime?
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt

  chats     chat[]
  feedbacks ratings_feedback[]
}

// -------------------- CHAT + MESSAGE --------------------

model chat {
  id                    String                  @id @default(uuid()) @db.Uuid
  job_id                Int?
  job                   jobs?                   @relation(fields: [job_id], references: [id])
  customer_id           Int
  customer              customers               @relation(fields: [customer_id], references: [id])
  provider_id           Int
  service_provider      service_providers       @relation(fields: [provider_id], references: [id])
  lsm_id                Int?
  local_service_manager local_service_managers? @relation(fields: [lsm_id], references: [id])
  is_active             Boolean                 @default(true)
  created_at            DateTime                @default(now())
  messages              messages[]
}

model messages {
  id           String      @id @default(uuid()) @db.Uuid
  chat_id      String      @db.Uuid
  chat         chat        @relation(fields: [chat_id], references: [id])
  sender_type  SenderType
  sender_id    Int
  message_type MessageType @default(text)
  message      String?
  created_at   DateTime    @default(now())
}

// -------------------- RATINGS + FEEDBACK --------------------

model ratings_feedback {
  id                  Int                @id @default(autoincrement())
  job_id              Int
  job                 jobs               @relation(fields: [job_id], references: [id])
  customer_id         Int
  customer            customers          @relation(fields: [customer_id], references: [id])
  rating              Int?               @default(0)
  feedback            String?
  punctuality_rating  Int?               @default(0)
  response_time       Int?               @default(0)
  created_at          DateTime           @default(now())
  service_providers   service_providers? @relation(fields: [service_providersId], references: [id])
  service_providersId Int?
}

// -------------------- NOTIFICATIONS --------------------

model notifications {
  id             String              @id @default(uuid()) @db.Uuid
  recipient_type SenderType
  recipient_id   Int
  type           NotificationType
  title          String
  message        String
  channel        NotificationChannel
  is_read        Boolean             @default(false) // ðŸ”¹ for tracking
  created_at     DateTime            @default(now())
}
